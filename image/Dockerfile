FROM  namshi/smtp
LABEL maintainer "Erwin Mueller <erwin.mueller@deventm.com>"

ADD rootfs/docker-entrypoint.sh /docker-entrypoint.sh

ADD rootfs/entrypoint.sh /bin/entrypoint.sh

ADD rootfs/set-exim4-update-conf /bin/set-exim4-update-conf

ADD rootfs/update-exim4.conf /usr/sbin/update-exim4.conf

ADD rootfs/config.autogenerated /var/lib/exim4/config.autogenerated

ENV CUSER Debian-exim

RUN set -x \
  && ln -sf /dev/stdout /var/log/exim4/mainlog \
  && ln -sf /dev/stderr /var/log/exim4/rejectlog \
  && chmod +x /docker-entrypoint.sh \
  && chmod +x /bin/entrypoint.sh \
  && chmod +x /bin/set-exim4-update-conf \
  && chmod +x /usr/sbin/update-exim4.conf \
  && touch /var/lib/exim4/config.autogenerated \
  && chown ${CUSER}.${CUSER} -R /etc/exim4 /var/lib/exim4 \
  && chown root.${CUSER} /var/lib/exim4/config.autogenerated \
  && chmod 0640 /var/lib/exim4/config.autogenerated \
  && chown root.${CUSER} -R \
    /etc/mailname \
  && chmod u=rwX,g=rwX,o=rX -R \
    /etc/mailname

# Finishing up.

ENV CFILEMODE 0640

EXPOSE 8025

USER ${CUSER}

ENTRYPOINT ["/docker-entrypoint.sh"]

CMD ["exim", "-bd", "-q15m", "-v"]
